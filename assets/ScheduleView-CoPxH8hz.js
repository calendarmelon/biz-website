import{j as e,P as w,u as se,C as J}from"./index-BheFCFOF.js";import{a as c}from"./vendor-CMvHcHbC.js";import{a as le,u as oe}from"./redux-IAqEd8mO.js";import{b as U,a as N,c as Z}from"./index.esm-CuCM43ir.js";import{C as te,d as ce,e as de,f as $,h as B,i as ee,j as me,k as ue,u as he,P as pe,l as fe,m as xe,n as je,o as ye,p as _e,q as ge,r as ve,s as be}from"./DefaultLayout-VyzN2NJU.js";import{u as X}from"./storage-B4ijfEY4.js";import{g as Ce,b as Ne}from"./staff-D8zrfuMw.js";import{d as K,e as Q,b as Se,c as R}from"./CForm-B94iwgBD.js";import{c as we}from"./cil-clock-0brlqJOZ.js";import{c as Ae}from"./cil-user-Ddrdy7PS.js";import{a as H,b as M,c as S}from"./CRow-F-29Amx2.js";import{c as De}from"./cil-options-sHCm5Gxk.js";import{C as Ee}from"./CCardHeader-CN94IKlH.js";const ae=({appointment:a,onClick:_,hideClientPII:f})=>{var t;const{t:r}=X(),T=i=>({scheduled:"info",confirmed:"success",in_progress:"warning",completed:"secondary",cancelled:"danger",no_show:"dark"})[i]||"primary",o=i=>i.substring(0,5),L=()=>{var i,g,x;return f?((i=a.clients)==null?void 0:i.first_name)||r("schedule.card.client"):`${((g=a.clients)==null?void 0:g.first_name)||""} ${((x=a.clients)==null?void 0:x.last_name)||""}`.trim()};return e.jsx(K,{className:"mb-2 cursor-pointer hover-shadow",onClick:_,style:{cursor:"pointer"},children:e.jsx(Q,{className:"py-2 px-3",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-start",children:[e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("div",{className:"d-flex align-items-center gap-2 mb-1",children:[e.jsx(U,{icon:we,size:"sm"}),e.jsxs("strong",{children:[o(a.start_time)," - ",o(a.end_time)]}),e.jsx(te,{color:T(a.status),children:a.status})]}),e.jsxs("div",{className:"mb-1",children:[e.jsx("strong",{className:"text-primary",children:(t=a.services)==null?void 0:t.name}),e.jsxs("span",{className:"text-muted ms-2",children:["(",a.duration_minutes," ",r("schedule.card.min"),")"]})]}),e.jsxs("div",{className:"d-flex align-items-center gap-3 text-muted small",children:[e.jsxs("div",{className:"d-flex align-items-center gap-1",children:[e.jsx(U,{icon:Ae,size:"sm"}),e.jsx("span",{children:L()})]}),a.employees&&e.jsxs("div",{children:[r("schedule.card.staff")," ",a.employees.first_name," ",a.employees.last_name]}),e.jsxs("div",{className:"ms-auto",children:[a.total_amount," PLN"]})]}),a.client_notes&&e.jsxs("div",{className:"mt-1 small text-muted",children:[r("schedule.card.note")," ",a.client_notes]})]}),e.jsx(H,{color:"light",size:"sm",onClick:i=>{i.stopPropagation(),_()},children:e.jsx(U,{icon:De})})]})})})};ae.propTypes={appointment:w.object.isRequired,onClick:w.func.isRequired,hideClientPII:w.bool};const ne=({appointment:a,onSubmit:_,onCancel:f,loading:r,error:T})=>{const{business:o,user:L}=se(),{t}=X(),[i,g]=c.useState({client_id:"",employee_id:"",service_id:"",appointment_date:"",start_time:"",client_notes:"",internal_notes:"",status:"scheduled"}),[x,A]=c.useState([]),[k,z]=c.useState([]),[D,G]=c.useState([]),[p,v]=c.useState(null),[q,E]=c.useState(!0),[I,y]=c.useState("");c.useEffect(()=>{V()},[o==null?void 0:o.id]),c.useEffect(()=>{var s;a&&g({client_id:a.client_id||"",employee_id:a.employee_id||"",service_id:a.service_id||"",appointment_date:a.appointment_date||"",start_time:((s=a.start_time)==null?void 0:s.substring(0,5))||"",client_notes:a.client_notes||"",internal_notes:a.internal_notes||"",status:a.status||"scheduled"})},[a]),c.useEffect(()=>{if(i.service_id&&D.length>0){const s=D.find(m=>m.id===i.service_id);v(s)}},[i.service_id,D]);const V=async()=>{if(!(o!=null&&o.id))return;E(!0);const[s,m,u]=await Promise.all([ce(o.id),Ce(o.id),de(o.id)]);s.data&&A(s.data),m.data&&z(m.data),u.data&&G(u.data),E(!1)},b=(s,m)=>{if(!s||!m)return"";const[u,d]=s.split(":").map(Number),P=u*60+d+m,C=Math.floor(P/60),n=P%60;return`${String(C).padStart(2,"0")}:${String(n).padStart(2,"0")}:00`},j=s=>{const{name:m,value:u}=s.target;if(y(""),m==="appointment_date"&&u){const d=W(u);if(!d.valid){y(d.reason);return}}g(d=>({...d,[m]:u}))},W=s=>{var m,u;if(me(s)){const d=ue(s);return{valid:!1,reason:`${t("appointments.availability.holiday")}: ${d}`}}if(o!=null&&o.business_hours){const d=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],P=new Date(s+"T00:00:00"),C=d[P.getDay()],n=o.business_hours[C];if((n==null?void 0:n.closed)===!0)return{valid:!1,reason:t("appointments.availability.businessClosed")}}if(i.employee_id){const d=k.find(O=>O.id===i.employee_id),C=(((m=d==null?void 0:d.working_hours)==null?void 0:m.unavailableDates)||[]).find(O=>O.date===s);if(C)return{valid:!1,reason:`${t("appointments.availability.timeOff")}: ${C.reason||""}`};const n=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],l=new Date(s+"T00:00:00"),h=n[l.getDay()],F=(u=d==null?void 0:d.working_hours)==null?void 0:u[h];if(!F||!F.available)return{valid:!1,reason:t("appointments.availability.employeeNotScheduled")}}return{valid:!0}},Y=s=>{if(s.preventDefault(),!p){alert(t("schedule.form.selectServiceError"));return}const m=b(i.start_time,p.duration_minutes),u={...i,business_id:o.id,start_time:`${i.start_time}:00`,end_time:m,duration_minutes:p.duration_minutes,service_price:p.price,total_amount:p.price,currency:"PLN",booking_reference:a?a.booking_reference:"REF"+Math.random().toString(36).substr(2,6).toUpperCase()};_(u)};return q?e.jsx("div",{className:"text-center py-4",children:e.jsx(J,{color:"primary"})}):e.jsxs(Se,{onSubmit:Y,children:[T&&e.jsx(R,{color:"danger",className:"mb-3",children:T}),I&&e.jsx(R,{color:"danger",className:"mb-3",dismissible:!0,onClose:()=>y(""),children:I}),e.jsxs(M,{className:"mb-3",children:[e.jsxs(S,{md:6,children:[e.jsxs(N,{htmlFor:"client_id",children:[t("schedule.form.client")," *"]}),e.jsxs($,{id:"client_id",name:"client_id",value:i.client_id,onChange:j,required:!0,disabled:r,children:[e.jsx("option",{value:"",children:t("schedule.form.selectClient")}),x.map(s=>e.jsxs("option",{value:s.id,children:[s.first_name," ",s.last_name]},s.id))]})]}),e.jsxs(S,{md:6,children:[e.jsxs(N,{htmlFor:"service_id",children:[t("schedule.form.service")," *"]}),e.jsxs($,{id:"service_id",name:"service_id",value:i.service_id,onChange:j,required:!0,disabled:r,children:[e.jsx("option",{value:"",children:t("schedule.form.selectService")}),D.map(s=>e.jsxs("option",{value:s.id,children:[s.name," - ",s.price," PLN (",s.duration_minutes," ",t("common.labels.min"),")"]},s.id))]})]})]}),e.jsxs(M,{className:"mb-3",children:[e.jsxs(S,{md:6,children:[e.jsx(N,{htmlFor:"employee_id",children:t("schedule.form.staffMember")}),e.jsxs($,{id:"employee_id",name:"employee_id",value:i.employee_id,onChange:j,disabled:r,children:[e.jsx("option",{value:"",children:t("schedule.form.anyAvailable")}),k.filter(s=>s.status==="active").map(s=>e.jsxs("option",{value:s.id,children:[s.first_name," ",s.last_name]},s.id))]})]}),e.jsxs(S,{md:6,children:[e.jsx(N,{htmlFor:"status",children:t("schedule.form.status")}),e.jsxs($,{id:"status",name:"status",value:i.status,onChange:j,disabled:r,children:[e.jsx("option",{value:"scheduled",children:t("schedule.form.statusScheduled")}),e.jsx("option",{value:"confirmed",children:t("schedule.form.statusConfirmed")}),e.jsx("option",{value:"in_progress",children:t("schedule.form.statusInProgress")}),e.jsx("option",{value:"completed",children:t("schedule.form.statusCompleted")}),e.jsx("option",{value:"cancelled",children:t("schedule.form.statusCancelled")}),e.jsx("option",{value:"no_show",children:t("schedule.form.statusNoShow")})]})]})]}),e.jsxs(M,{className:"mb-3",children:[e.jsxs(S,{md:6,children:[e.jsxs(N,{htmlFor:"appointment_date",children:[t("schedule.form.date")," *"]}),e.jsx(Z,{id:"appointment_date",name:"appointment_date",type:"date",value:i.appointment_date,onChange:j,min:B(new Date),required:!0,disabled:r})]}),e.jsxs(S,{md:6,children:[e.jsxs(N,{htmlFor:"start_time",children:[t("schedule.form.startTime")," *"]}),e.jsx(Z,{id:"start_time",name:"start_time",type:"time",value:i.start_time,onChange:j,required:!0,disabled:r})]})]}),p&&e.jsxs(R,{color:"info",className:"mb-3",children:[t("schedule.form.duration")," ",p.duration_minutes," ",t("common.labels.minutes")," |",t("schedule.form.price")," ",p.price," PLN"]}),e.jsx(M,{className:"mb-3",children:e.jsxs(S,{children:[e.jsx(N,{htmlFor:"client_notes",children:t("schedule.form.clientNotes")}),e.jsx(ee,{id:"client_notes",name:"client_notes",rows:"2",value:i.client_notes,onChange:j,disabled:r})]})}),e.jsx(M,{className:"mb-3",children:e.jsxs(S,{children:[e.jsx(N,{htmlFor:"internal_notes",children:t("schedule.form.internalNotes")}),e.jsx(ee,{id:"internal_notes",name:"internal_notes",rows:"2",value:i.internal_notes,onChange:j,disabled:r})]})}),e.jsxs("div",{className:"d-flex justify-content-end gap-2",children:[e.jsx(H,{color:"secondary",onClick:f,disabled:r,children:t("schedule.form.cancel")}),e.jsx(H,{color:"primary",type:"submit",disabled:r,children:r?e.jsxs(e.Fragment,{children:[e.jsx(J,{size:"sm",className:"me-2"}),t("schedule.form.saving")]}):t(a?"schedule.form.updateAppointment":"schedule.form.createAppointment")})]})]})};ne.propTypes={appointment:w.object,onSubmit:w.func.isRequired,onCancel:w.func.isRequired,loading:w.bool,error:w.string};const He=()=>{const a=le(),{business:_,user:f}=se(),{t:r,locale:T}=X();he({pageType:pe.SCHEDULE});const{appointments:o,loading:L,error:t,filters:i}=oe(n=>n.appointments),[g,x]=c.useState(!1),[A,k]=c.useState(null),[z,D]=c.useState(!1),[G,p]=c.useState(null),[v,q]=c.useState(null),[E,I]=c.useState(null),[y,V]=c.useState({}),b=_==null?void 0:_.id;c.useEffect(()=>{b&&f&&j()},[b,f]),c.useEffect(()=>{b&&v!==null&&W()},[b,i,v,E]),c.useEffect(()=>{o&&Y()},[o]);const j=async()=>{var l;const n=(l=f==null?void 0:f.user_metadata)==null?void 0:l.role;if(n==="business_owner"||n==="manager")q("admin"),I(null);else{q("employee");const{data:h}=await Ne(f.id);h&&I(h.id)}},W=async()=>{console.log("[todo] loading appointments"),a({type:"APPOINTMENTS_LOADING"});const n={...i};v==="employee"&&E&&(n.employeeId=E);const{data:l,error:h}=await fe(b,n);console.log("[todo getAppointments] response",{data:l,error:h}),h?(console.log("[todo] Error loading appointments"),a({type:"APPOINTMENTS_ERROR",payload:h})):(console.log("[todo] Appointments loaded successfully"),a({type:"APPOINTMENTS_SUCCESS",payload:l||[]}))},Y=()=>{const n={};o.forEach(l=>{const h=l.appointment_date;n[h]||(n[h]=[]),n[h].push(l)}),V(n)},s=()=>{k(null),p(null),x(!0)},m=n=>{k(n),p(null),x(!0)},u=async n=>{D(!0),p(null);let l;A?l=await ve(A.id,n):l=await be(n),D(!1),l.error?p(l.error):(a(A?{type:"UPDATE_APPOINTMENT",payload:l.data}:{type:"ADD_APPOINTMENT",payload:l.data}),x(!1))},d=n=>{const l=new Date(n),h=new Date,F=new Date(h);F.setDate(F.getDate()+1);const O=B(l),ie=B(h),re=B(F);return O===ie?r("schedule.today"):O===re?r("schedule.tomorrow"):l.toLocaleDateString(T,{weekday:"long",year:"numeric",month:"long",day:"numeric"})},P=n=>v==="admin"||v==="employee"&&n.employee_id===E,C=v==="employee";return b?e.jsxs(e.Fragment,{children:[e.jsxs(K,{className:"mb-4",children:[e.jsxs(Ee,{className:"d-flex justify-content-between align-items-center",children:[e.jsx("strong",{children:r("schedule.title")}),e.jsxs(H,{color:"primary",onClick:s,children:[e.jsx(U,{icon:xe,className:"me-2"}),r("schedule.newAppointment")]})]}),e.jsxs(Q,{children:[t&&e.jsx(R,{color:"danger",className:"mb-3",children:t}),L?e.jsx("div",{className:"text-center py-5",children:e.jsx(J,{color:"primary"})}):Object.keys(y).length===0?e.jsx("div",{className:"text-center py-5 text-muted",children:r("schedule.emptyState")}):e.jsx("div",{children:Object.keys(y).sort().map(n=>e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"d-flex align-items-center gap-2 mb-3",children:[e.jsx("h5",{className:"mb-0",children:d(n)}),e.jsxs(te,{color:"primary",className:"ms-2",children:[y[n].length," ",y[n].length!==1?r("schedule.appointments"):r("schedule.appointment")]})]}),y[n].map(l=>e.jsx(ae,{appointment:l,onClick:()=>P(l)&&m(l),hideClientPII:C},l.id))]},n))})]})]}),e.jsxs(je,{visible:g,onClose:()=>x(!1),size:"lg",children:[e.jsx(ye,{children:e.jsx(_e,{children:r(A?"schedule.editAppointment":"schedule.newAppointment")})}),e.jsx(ge,{children:e.jsx(ne,{appointment:A,onSubmit:u,onCancel:()=>x(!1),loading:z,error:G})})]})]}):e.jsx(K,{children:e.jsx(Q,{children:e.jsx(R,{color:"warning",children:r("schedule.noBusinessWarning")})})})};export{He as default};
